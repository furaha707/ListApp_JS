<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<link rel="stylesheet" href="./assets/css/common.min.css" />
		<link rel="stylesheet" href="./assets/css/main.min.css" />
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous" />
		<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/xeicon@2.3.3/xeicon.min.css" />
	</head>
	<body>
		<main>
			<nav class="navbar navbar-expand-lg bg-body-tertiary">
				<div class="container-fluid">
					<a href="/" class="navbar-brand">내담자등록관리</a>
					<span id="nickname" class="ms-auto mx-2">로그인 후 이용해주세요</span>
					<ul class="navbar-nav mb-2 mb-lg-0">
						<li class="nav-item">
							<button type="button" id="login" class="btn btn-danger" onClick="location.href='/sub/login.html'">로그인</button>
							<button type="button" id="logout-btn" class="btn btn-dark">로그아웃</button>
						</li>
					</ul>
				</div>
			</nav>
			<div class="list-container">
				<div id="search-area">
					<div class="search-wrap">
						<input type="text" class="form-control" id="search-input" />
						<div class="btn-inner">
							<button type="submit" id="search-btn">
								<i class="xi xi-search"></i>
							</button>
							<button type="button" id="reset-btn">
								<i class="xi xi-refresh"></i>
							</button>
						</div>
					</div>
					<button type="button" class="btn" id="create-btn">신규등록</button>

					<button type="button" class="btn" id="delete-btn">선택삭제</button>
				</div>
				<!-- 필터는 where query 사용해서 내가 직접 해보기 -->
				<!-- <div class="filter-wrap mb-10" id="filter-area">
					<input type="checkbox" id="filter-counseling" />
					<label for="filter-counseling">상담</label>
					<input type="checkbox" id="filter-conclusion" />
					<label for="filter-conclusion">종결</label>
					<input type="checkbox" id="filter-treatment" />
					<label for="filter-treatment">치료</label>
				</div> -->

				<div class="list-wrapper">
					<input type="checkbox" id="selectall" name="selectall" value="selectall" onclick="selectAll(this)" />
					<label for="selectall">전체선택</label>
					<div id="list-area"></div>
				</div>
			</div>
		</main>
		<script src="/__/firebase/8.6.5/firebase-app.js"></script>
		<script src="/__/firebase/8.6.5/firebase-auth.js"></script>
		<script src="/__/firebase/8.6.5/firebase-firestore.js"></script>
		<script src="/__/firebase/8.6.5/firebase-storage.js"></script>
		<script src="./assets/js/main.js"></script>
		<script src="./assets/js/login.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
		<script>
			let profileListWrap = document.getElementById('list-area');
			const createBtn = document.getElementById('create-btn');
			const deleteBtn = document.getElementById('delete-btn');
			const searchBtn = document.getElementById('search-btn');
			const searchInput = document.getElementById('search-input');
			const resetBtn = document.getElementById('reset-btn');

			// 기본적으로 초기 렌더링해주고 현재 데이터로 가지고
			const render = function () {
				db.collection('person')
					.get()
					.then((result) => {
						let profileList = '';
						result.forEach((doc) => {
							profileList += `
      <a href="./sub/sub.html?id=${doc.id}" class="list-item card">
				<input type="checkbox" name="selection" value="${doc.data().name}" onclick="checkSelectAll()"/>
        <p class="card-img-wrap">
          <img src="${doc.data().image}" class="card-img-top" />
        </p>
        <div class="card-body">

        <p class="card-title">${doc.data().name}</p>
        <p class="card-text">${doc.data().age}</p>
        <p class="btn btn-primary">${doc.data().sort}</p>
      </div>
      </a>
			`;
						});

						profileListWrap.innerHTML = profileList;
					});
			};

			render();

			// 새로 등록할 페이지로 가야지
			const createList = function () {
				// data 에 추가
				// render();
				window.location.href = './sub/regis.html';
			};

			// 체크된 아이템은 삭제해줄거야 데이터에서. 그리고 다시 렌더링해
			const deleteList = function () {
				console.log('삭제하기');
				// 삭제하려는 문서의 ID를 가져옵니다.
				let deleteList = [];

				const checkboxes = document.querySelectorAll('input[name="selection"]:checked');
				console.log(checkboxes);

				checkboxes.forEach((checkbox) => {
					const checkedParent = checkbox.closest('a');
					let docIdToDelete = checkedParent.getAttribute('href').split('id=')[1];
					deleteList.push(docIdToDelete);

					Promise.all(deleteList.map((docId) => db.collection('person').doc(docId).delete()))
						.then(() => {
							console.log('Document successfully deleted!');
							render();
						})
						.catch((error) => {
							console.error('Error deleting document: ', error);
						});
				});
			};

			resetBtn.addEventListener('click', function () {
				location.reload();
			});

			searchInput.addEventListener('keypress', function (event) {
				if (event.key === 'Enter') {
					searchList();
				}
			});

			searchBtn.addEventListener('click', searchList);

			function searchList() {
				const inputValue = searchInput.value;

				db.collection('person')
					.where('name', '>=', inputValue)
					.where('name', '<=', inputValue + '\uf8ff')
					.get()
					.then((result) => {
						let profileList = '';
						result.forEach((doc) => {
							profileList += `
							<a href="./sub/sub.html?id=${doc.id}" class="list-item card">
				<input type="checkbox" name="selection" value="${doc.data().name}" onclick="checkSelectAll()"/>
        <p class="card-img-wrap">
          <img src="${doc.data().image}" class="card-img-top" />
        </p>
        <div class="card-body">

        <p class="card-title">${doc.data().name}</p>
        <p class="card-text">${doc.data().age}</p>
        <p class="btn btn-primary">${doc.data().sort}</p>
      </div>
      </a>
					`;
						});

						profileListWrap.innerHTML = profileList;
					});
			}

			createBtn.addEventListener('click', createList);
			deleteBtn.addEventListener('click', deleteList);
			searchBtn.addEventListener('click', searchList);

			// 체크박스 전체선택 및 해제
			function checkSelectAll() {
				// 전체 체크박스
				const checkboxes = document.querySelectorAll('input[name="selection"]');
				// 선택된 체크박스
				const checked = document.querySelectorAll('input[name="selection"]:checked');
				// select all 체크박스
				const selectAll = document.querySelector('input[name="selectall"]');

				if (checkboxes.length === checked.length) {
					selectAll.checked = true;
				} else {
					selectAll.checked = false;
				}
			}

			function selectAll(selectAll) {
				const checkboxes = document.getElementsByName('selection');

				checkboxes.forEach((checkbox) => {
					checkbox.checked = selectAll.checked;
				});
			}
		</script>
	</body>
</html>

