<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous" />
	</head>
	<body>
		<nav class="navbar navbar-expand-lg bg-body-tertiary">
			<div class="container-fluid">
				<a href="/" class="navbar-brand">내담자등록관리</a>
				<span id="nickname" class="ms-auto mx-2">로그인 후 이용해주세요</span>
				<ul class="navbar-nav mb-2 mb-lg-0">
					<li class="nav-item">
						<button type="button" id="login" class="btn btn-danger" onClick="location.href='/sub/login.html'">로그인</button>
						<button type="button" id="logout-btn" class="btn btn-dark">로그아웃</button>
					</li>
				</ul>
			</div>
		</nav>
		<div class="container">
			<input type="file" id="image" />
			<p class="preview-wrap">
				<img src="" alt="" id="image-preview" />
			</p>
			<!-- 이미지는 db에 저장하지 않음. 용량 때문에 -->
			<input type="text" class="form-control" id="name" placeholder="이름" />
			<input type="text" class="form-control" id="age" placeholder="나이" />
			<select id="sort" class="form-control">
				<option value="">선택하세요</option>
				<option value="상담">상담</option>
				<option value="종결">종결</option>
				<option value="치료">치료</option>
			</select>

			<button class="btn btn-danger" id="send-btn">올리기</button>
		</div>
		<script src="/__/firebase/8.6.5/firebase-app.js"></script>
		<script src="/__/firebase/8.6.5/firebase-auth.js"></script>
		<script src="/__/firebase/8.6.5/firebase-firestore.js"></script>
		<script src="/__/firebase/8.6.5/firebase-storage.js"></script>
		<script src="../assets/js/main.js"></script>
		<script src="../assets/js/login.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
		<script>
			const sendBtn = document.getElementById('send-btn');
			const storage = firebase.storage();
			let imageUrl = '';
			const auth = firebase.auth();
			const imageInput = document.getElementById('image');
			const imagePreview = document.getElementById('image-preview');
			const previewWrap = document.querySelector('.preview-wrap');
			const deleteBtn = document.querySelector('delete-btn');

			// 이미지 미리보기
			imageInput.addEventListener('change', function (event) {
				const selectedImage = event.target.files[0];

				if (selectedImage) {
					const reader = new FileReader();

					reader.onload = function (e) {
						imagePreview.src = e.target.result;
					};

					reader.readAsDataURL(selectedImage);

					// const imageDelete = document.createElement('button');
					// imageDelete.classList.add('delete-btn');
					// imageDelete.textContent = 'X';

					// previewWrap.appendChild(imageDelete);

					// imageDelete.addEventListener('click', function () {
					// 	imagePreview.src = '';
					// 	imageInput.value = '';
					// 	imageDelete.remove();
					// });
				} else {
					imagePreview.src = '';
				}
			});

			auth.onAuthStateChanged((user) => {
				if (user) {
					// 사용자가 로그인한 상태
					// 상품 업로드 관련 로직 실행
					const sendData = function () {
						// 이미지 저장하기
						let file = document.querySelector('#image').files[0];
						let storageRef = storage.ref();
						let storageDir = storageRef.child('image/' + file.name);
						let storageUpload = storageDir.put(file);

						// 이미지 url 구하기
						storageUpload.on(
							'state_changed',
							// 변화시 동작하는 함수
							null,
							//에러시 동작하는 함수
							(error) => {
								console.error('실패사유는', error);
							},
							// 성공시 동작하는 함수
							() => {
								storageUpload.snapshot.ref.getDownloadURL().then((url) => {
									console.log('업로드된 경로는', url);
									imageUrl = url;
									// 입력한 값 등록하기
									let nameValue = document.getElementById('name').value;
									let ageValue = Number(document.getElementById('age').value);
									let sortValue = document.getElementById('sort').value;

									db.collection('person')
										.add({
											name: nameValue,
											age: ageValue,
											sort: sortValue,
											image: imageUrl,
											uid: JSON.parse(localStorage.getItem('user')).uid,
										})
										.then((result) => {
											console.log(result);
											alert('저장 완료되었습니다');
											window.location.href = '../index.html';
											// 성공 후에 실행할 코드
										})
										.catch((err) => {
											alert(err);
											// 실패 후에 실행할 코드
										});
								});
							}
						);
					};
					sendBtn.addEventListener('click', sendData);
				} else {
					// 사용자가 로그인하지 않은 상태
					// 로그인 페이지로 리다이렉트 또는 로그인을 유도하는 메시지 표시 등
					alert('로그인 후에 사용 가능합니다');
					window.location.href = './login.html';
				}
			});
		</script>
	</body>
</html>

